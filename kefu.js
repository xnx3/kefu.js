var goodsUrl="https://yunkefu.obs.cn-north-4.myhuaweicloud.com/html/json/";function generateUUID(){var e=(new Date).getTime();return window.performance&&"function"==typeof window.performance.now&&(e+=performance.now()),"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:3&n|8).toString(16)})}function getUrlParams(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),n=window.location.search.substr(1).match(t);return null!=n?unescape(n[2]):null}function formatNumber(e){return(e=e.toString())[1]?e:"0"+e}function formatTime(e,t){var n=["Y","M","D","h","m","s"],i=[];10==(e+"").length&&(e*=1e3);var o=new Date(e);for(var c in i.push(o.getFullYear()),i.push(formatNumber(o.getMonth()+1)),i.push(formatNumber(o.getDate())),i.push(formatNumber(o.getHours())),i.push(formatNumber(o.getMinutes())),i.push(formatNumber(o.getSeconds())),i)t=t.replace(n[c],i[c]);return t}var request={get:function(e,t,n){this.send(e,t,n,"get",!0,{"content-type":"application/x-www-form-urlencoded"},null)},post:function(e,t,n){this.send(e,t,n,"POST",!0,{"content-type":"application/x-www-form-urlencoded"},null)},send:function(e,t,n,i,o,c,s){var a="";if(null!=t)for(var u in t)a.length>0&&(a+="&"),a=a+u+"="+t[u];var r=null;try{r=new XMLHttpRequest}catch(e){r=new ActiveXObject("Microsoft.XMLHTTP")}if(r.open(i,e,o),null!=c)for(var u in c)r.setRequestHeader(u,c[u]);r.send(a),r.onreadystatechange=function(){if(4==r.readyState)if(200==r.status){var e=null;try{e=JSON.parse(r.responseText)}catch(e){console.log(e)}n(null==e?r.responseText:e)}else null!=s&&s(r)}},upload:function(e,t,n,i,o,c){var s=new FormData;if(s.append("file",n),null!=t)for(var a in t)s.append(a,t[a]);var u=null;try{u=new XMLHttpRequest}catch(e){u=new ActiveXObject("Microsoft.XMLHTTP")}if(u.open("POST",e,!0),null!=o)for(var a in o)u.setRequestHeader(a,o[a]);u.send(s),u.onreadystatechange=function(){if(4==u.readyState)if(200==u.status){var e=null;try{e=JSON.parse(u.responseText)}catch(e){console.log(e)}i(null==e?u.responseText:e)}else null!=c&&c(u)}}},kefu={api:{getMyUser:"",getChatOtherUser:"",chatLog:"",uploadImage:""},user:{},currentPage:"list",mode:"mobile",remindVoicePath:"https://res.weiunity.com/kefu/media/voice.mp3",init:function(){var e=document.getElementsByTagName("head")[0];for(var t in kefu.extend){if(null!=kefu.extend[t].js&&kefu.extend[t].js.length>0){var n=document.createElement("script");n.type="text/javascript",n.src=kefu.extend[t].js,e.appendChild(n)}if(null!=kefu.extend[t].css&&kefu.extend[t].css.length>0){var i=document.createElement("link");i.type="text/css",i.rel="stylesheet",i.href=kefu.extend[t].css,e.appendChild(i)}if(null!=kefu.extend[t].init)try{kefu.extend[t].init()}catch(e){console.log(e)}}kefu.notification.audio.load()},notification:{use:!0,audioPath:"https://res.weiunity.com/kefu/media/voice.mp3",execute:function(e,t){if(kefu.notification.use){try{kefu.notification.audio.play()}catch(e){console.log(e)}if("https:"==document.location.protocol){if(null!=window.Notification)if("granted"===Notification.permission)new Notification(e,{body:t,silent:!1});else Notification.requestPermission()}else console.log("当前使用的不是https请求！只有https请求才可以有浏览器消息通知。这里只是声音通知")}},audio:{audioBuffer:null,audioContext:new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext),load:function(){if(null==kefu.notification.audioPath||kefu.notification.audioPath.length<1)console.log("已将 kefu.notification.audioPath 设为空，将不再出现声音提醒");else{var e=new XMLHttpRequest;e.open("GET",kefu.notification.audioPath,!0),e.responseType="arraybuffer",e.onload=function(e){kefu.notification.audio.audioContext.decodeAudioData(this.response,function(e){kefu.notification.audio.audioBuffer=e},function(e){console.log("kefu.notification.load() Error decoding file",e)})},e.send()}},play:function(){if(null!=kefu.notification.audio.audioBuffer){var e=kefu.notification.audio.audioContext.createBufferSource();e.buffer=kefu.notification.audio.audioBuffer,e.connect(kefu.notification.audio.audioContext.destination),e.start(0)}else kefu.notification.audio.load()}}},storage:{get:function(e){return localStorage.getItem(e)},set:function(e,t){localStorage.setItem(e,t)}},token:{token:null,get:function(){return null==this.token&&(this.token=kefu.storage.get("token")),(null==this.token||this.token.length<5)&&(this.token="youke_"+generateUUID()),this.set(this.token),this.token},set:function(e){this.token=e,kefu.storage.set("token",this.token)}},getMyUser:function(e){null==kefu.api.getMyUser||kefu.api.getMyUser.length<1?msg.popups("请设置 kefu.api.getMyUser 接口，用于获取当前用户(我)的信息"):request.post(kefu.api.getMyUser,{token:kefu.token.get()},function(t){kefu.user=t.user,"function"==typeof e&&e(t)})},filterXSS:function(e){return e=(e=(e=e.replace(/<\/?[^>]*>/g,"")).replace(/[|]*\n/,"")).replace(/&npsp;/gi,"")},getImageUrl:function(e){return void 0===e?"":0==e.indexOf("http://")||0==e.indexOf("https://")?e:0!=e.indexOf("//")?e:"file:"==window.location.protocol?"http:"+e:e},ubb:function(e){return e.replace(/\[ul\]/g,"<ul>").replace(/\[\/ul\]/g,"</ul>").replace(/\[li\]/g,'<li onclick="kefu.chat.question(this);" class="question">').replace(/\[\/li\]/g,"</li>").replace(/\[br\]/g,"<br>")},client:{isMobile:function(){return!!navigator.userAgent.match(/(iPhone|iPod|Android|ios|iOS|iPad|Backerry|WebOS|Symbian|Windows Phone|Phone)/i)}},getReceiveMessageText:function(e){return null!=e.extend&&null!=e.extend.extend&&(e=kefu.extend[e.extend.extend].format(e)),e.text=kefu.ubb(e.text),e.text},ui:{color:{shuruTypeColor:"#1296db",extendIconColor:"#808080"},images:{more:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1603880506122" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7418" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><style type="text/css"></style></defs><path d="M512.512 112.384c-219.6992 0-398.4896 178.7392-398.4896 398.4896 0 219.6992 178.7392 398.4896 398.4896 398.4896 219.6992 0 398.4896-178.7392 398.4896-398.4896s-178.7392-398.4896-398.4896-398.4896z m167.8848 424.0384H538.112v142.2848c0 14.1312-11.4688 25.6-25.6 25.6s-25.6-11.4688-25.6-25.6v-142.2848H344.6784c-14.1312 0-25.6-11.4688-25.6-25.6s11.4688-25.6 25.6-25.6H486.912V342.9888c0-14.1312 11.4688-25.6 25.6-25.6s25.6 11.4688 25.6 25.6v142.2848h142.2848c14.1312 0 25.6 11.4688 25.6 25.6s-11.4688 25.5488-25.6 25.5488z" fill="{color}" p-id="7419"></path></svg>',jianpan:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1603880701592" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10768" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><style type="text/css"></style></defs><path d="M513.788813 938.289925c-113.566274 0-220.223734-44.167967-300.444149-124.388381-80.220415-80.220415-124.388382-186.877876-124.388382-300.44415s44.167967-220.227983 124.388382-300.448398c165.543834-165.548083 435.348714-165.548083 600.892548 0 165.548083 165.548083 165.548083 435.348714 0 600.892548-80.220415 80.220415-186.877876 124.388382-300.44415 124.388381z m0-785.973112c-92.538158 0-185.072066 35.453344-255.379651 105.756681-68.2001 68.204349-105.75668 158.63927-105.756681 255.3839s37.556581 187.175303 105.756681 255.379652c68.204349 68.2001 158.936697 106.054108 255.379651 105.75668 96.74888 0 187.179552-37.556581 255.379652-105.75668 140.912598-140.912598 140.912598-369.850954 0-510.759303-70.303336-70.307585-162.841494-105.75668-255.379652-105.756681z" p-id="10769" fill="{color}"></path><path d="M318.672199 341.705826h46.313693c11.047303 0 19.545228 8.497925 19.545228 19.120332v46.313693c0 10.622407-8.497925 19.120332-19.120332 19.120332h-46.738589c-10.622407 0.424896-19.120332-8.073029-19.120332-18.695436v-46.738589c0-10.622407 8.497925-19.120332 19.120332-19.120332zM488.630705 341.705826h46.313693c11.047303 0 19.545228 8.497925 19.545229 19.120332v46.313693c0 10.622407-8.497925 19.120332-19.120332 19.120332h-46.73859c-10.622407 0.424896-19.120332-8.073029-19.120332-18.695436v-46.738589c0-10.622407 8.497925-19.120332 19.120332-19.120332zM658.589212 341.705826h46.313693c11.047303 0 19.545228 8.497925 19.545228 19.120332v46.313693c0 10.622407-8.497925 19.120332-19.120332 19.120332h-46.738589c-10.622407 0.424896-19.120332-8.073029-19.120332-18.695436v-46.738589c0-10.622407 8.497925-19.120332 19.120332-19.120332zM318.672199 469.174705h46.313693c10.622407 0 19.120332 8.497925 19.120332 19.120332v46.313693c0 10.622407-8.497925 19.120332-19.120332 19.120332H318.672199c-10.622407 0.424896-19.120332-8.073029-19.120332-18.695435v-46.73859c0-10.622407 8.497925-19.120332 19.120332-19.120332zM488.630705 469.174705h46.313693c10.622407 0 19.120332 8.497925 19.120332 19.120332v46.313693c0 10.622407-8.497925 19.120332-19.120332 19.120332h-46.313693c-10.622407 0.424896-19.120332-8.073029-19.120332-18.695435v-46.73859c0-10.622407 8.497925-19.120332 19.120332-19.120332zM658.589212 469.174705h46.313693c10.622407 0 19.120332 8.497925 19.120332 19.120332v46.313693c0 10.622407-8.497925 19.120332-19.120332 19.120332h-46.313693c-10.622407 0.424896-19.120332-8.073029-19.120332-18.695435v-46.73859c0-10.622407 8.497925-19.120332 19.120332-19.120332zM458.887967 660.378025h106.224066c17.420747 0 31.86722 14.446473 31.86722 31.86722s-14.446473 31.86722-31.86722 31.86722h-106.224066c-17.420747 0-31.86722-14.446473-31.86722-31.86722s14.446473-31.86722 31.86722-31.86722z" p-id="10770" fill="{color}"></path></svg>',close:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1604403666528" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1160" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><style type="text/css"></style></defs><path d="M583.168 523.776L958.464 148.48c18.944-18.944 18.944-50.176 0-69.12l-2.048-2.048c-18.944-18.944-50.176-18.944-69.12 0L512 453.12 136.704 77.312c-18.944-18.944-50.176-18.944-69.12 0l-2.048 2.048c-19.456 18.944-19.456 50.176 0 69.12l375.296 375.296L65.536 899.072c-18.944 18.944-18.944 50.176 0 69.12l2.048 2.048c18.944 18.944 50.176 18.944 69.12 0L512 594.944 887.296 970.24c18.944 18.944 50.176 18.944 69.12 0l2.048-2.048c18.944-18.944 18.944-50.176 0-69.12L583.168 523.776z" p-id="1161" fill="{color}"></path></svg>'},list:{renderAreaId:"",listItemTemplate:"",html:'\n\t\t\t\t<section id="chatlist">\n\n\t\t\t        <section class="item" onclick="kefu.ui.chat.entry(\'{id}\');">\n\t\t\t            <div class="head" style="background-image: url({head});"></div>\n\t\t\t            <div>\n\t\t\t                <div class="nickname">\n\t\t\t                    <span class="time">{time}</span>\n\t\t\t                    {nickname}\n\t\t\t                </div>\n\t\t\t                <div>\n\t\t\t                    <span class="num">{read}</span>\n\t\t\t                    <div class="text">{text}</div>\n\t\t\t                </div>\n\t\t\t            </div>\n\t\t\t        </section>\n\n\t\t\t    </section>\n\n\t\t\t    \x3c!-- <div style="position: absolute;bottom: 1rem;">\n\t\t\t        <a href="javascript:kefu.ui.chat.render(\'243\');" >测试聊天</a>\n\t\t\t    </div> --\x3e\n\t\t\t',getListItemByTemplate:function(e){var t="";return void 0!==e.read&&(e.read||(t="<div>&nbsp;</div>")),kefu.ui.list.listItemTemplate.replace(/{id}/g,e.id).replace(/{text}/g,e.text).replace(/{nickname}/g,e.nickname).replace(/{head}/g,kefu.getImageUrl(e.head)).replace(/{time}/g,formatTime(e.time,"M-D h:m")).replace(/{read}/g,t)},render:function(){kefu.ui.list.renderAreaId.length>0?null!=document.getElementById(kefu.ui.list.renderAreaId)&&(document.getElementById(kefu.ui.list.renderAreaId).innerHTML=kefu.ui.list.html):document.body.innerHTML=kefu.ui.list.html,kefu.ui.list.listItemTemplate.length<1&&(kefu.ui.list.listItemTemplate=document.getElementById("chatlist").innerHTML);for(var e=kefu.cache.getChatList(),t=e.length,n="",i=0;i<t;i++)n=kefu.ui.list.getListItemByTemplate(e[i])+n;""==n&&(n='<div class="not_hostory_list">当前还没有沟通记录</div>'),document.getElementById("chatlist").innerHTML=n},entry:function(){kefu.currentPage="list",kefu.ui.list.render()}},chat:{renderAreaId:"",html:'\n\t\t\t\t<div id="mobile">\n\t\t\t\t\t<header class="chat_header" id="head">\n\t\t\t\t        <div class="back" id="back" onclick="kefu.ui.list.entry();">&nbsp;</div>\n\t\t\t\t        <div class="title" id="title"><span id="nickname">在线咨询</span><span id="onlineState">在线</span></div>\n\t\t\t\t    </header>\n\t\t\t\t\t<div id="newMessageRemind">\n\t\t\t\t\t\t<div id="newMessageRemindText">\x3c!-- 新消息：消息内容消息内容 --\x3e</div>\n\t\t\t\t\t\t<div id="newMessageRemindClose" onclick="document.getElementById(\'newMessageRemind\').style.display=\'none\';">X</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t    <section id="chatcontent" onclick="kefu.chat.switchToJianpanShuruType();">\n\t\t\t\t    </section>\n\t\t\t\t    \n\t\t\t\t    <footer id="chat_footer">\n\t\t\t\t        <div id="input_area">\n\t\t\t\t            <div id="textInput">\n\t\t\t\t            \t<div id="shuruType" onclick="kefu.chat.shuruTypeChange();">\x3c!--输入方式--\x3e</div>\n\t\t\t\t                \x3c!-- 键盘输入 --\x3e\n\t\t\t\t                \x3c!-- <input type="text" id="text111" onclick="kefu.ui.chat.textInputClick();"> --\x3e\n\t\t\t\t                <div id="text" contenteditable="true" onclick="kefu.ui.chat.textInputClick();"></div>\n\t\t\t\t                <input type="submit" value="发送" class="send" id="sendButton" onclick="kefu.chat.sendButtonClick();">\n\t\t\t\t            </div>\n\t\t\t\t            <div id="inputExtend">\n\t\t\t\t                \x3c!-- 其他，如图片、商品、订单 --\x3e\n\t\n\t\t\t\t            </div>    \n\t\t\t\t            <div id="inputExtendShowArea">\n\t\t\t\t                \x3c!-- inputExtend的显示区域，如表情的显示 --\x3e\n\t\t\t\t            </div>\n\t\t\t\t        </div>\n\t\t\t\t    </footer>\n\t\t\t\t</div>\n\t\t\t',appendMessage:function(e){if("string"==typeof e&&(e=JSON.parse(e)),null!=e)if("SYSTEM"==e.type)kefu.ui.chat.appendSystemMessage(kefu.filterXSS(e.text));else{var t=kefu.ui.chat.generateMessageSection(e);document.getElementById("chatcontent").appendChild(t),kefu.ui.chat.scrollToBottom()}},generateMessageSection:function(e){e.text=kefu.getReceiveMessageText(e);var t=document.createElement("section");return e.receiveId==kefu.chat.otherUser.id?(t.className="chat user "+e.type,t.innerHTML='<div class="head"></div><div class="sanjiao"></div><div class="text">'+e.text+"</div>"):e.sendId==kefu.chat.otherUser.id&&(t.className="chat otherUser "+e.type,t.innerHTML='<div class="head" style="background-image: url('+kefu.getImageUrl(kefu.chat.otherUser.head)+');"></div><div class="sanjiao"></div><div class="text">'+e.text+"</div>"),t},generateSystemMessageSection:function(e){var t=document.createElement("section");return t.className="chat bot systemChat",t.innerHTML='<div class="text systemText">'+e+"</div>",t},scrollToBottom:function(){document.getElementById("chatcontent").scrollTo(0,document.getElementById("chatcontent").scrollHeight)},appendSystemMessage:function(e){chatcontent=document.getElementById("chatcontent"),chatcontent.innerHTML=chatcontent.innerHTML+'<section class="chat bot systemChat"><div class="text systemText">'+e+"</div></section>",kefu.ui.chat.scrollToBottom()},newMessageRemind:function(e){kefu.cache.getUser(e.sendId,function(t){var n=document.getElementById("newMessageRemindText");n.innerHTML=t.nickname+" : "+e.text,console.log(n),n.onclick=function(){kefu.ui.chat.render(e.sendId)},document.getElementById("newMessageRemind").style.display="block"})},textInputClick:function(){kefu.chat.switchToJianpanShuruType()},render:function(e){kefu.ui.list.renderAreaId.length>0?null!=document.getElementById(kefu.ui.chat.renderAreaId)&&(document.getElementById(kefu.ui.chat.renderAreaId).innerHTML=kefu.ui.chat.html):document.body.innerHTML=kefu.ui.chat.html,kefu.chat.otherUser={id:e,nickname:"加载中..",head:"./images/head.png"};for(var t=kefu.cache.getUserMessageList(kefu.chat.otherUser.id),n=0;n<t.length;n++){var i=t[n];kefu.ui.chat.appendMessage(i)}for(var o in kefu.chat.getOtherUser(e,function(e){document.getElementById("nickname").innerHTML=kefu.chat.otherUser.nickname,document.getElementById("onlineState").innerHTML=e.onlineState,null!=document.getElementById("otherUserHead")&&(document.getElementById("otherUserHead").src=kefu.getImageUrl(e.user.head));try{for(var n=document.getElementsByClassName("otherUser"),i=0;i<n.length;i++)n[i].getElementsByClassName("head")[0].style.backgroundImage="url('"+kefu.getImageUrl(kefu.chat.otherUser.head)+"')"}catch(e){console.log("当前chat聊天模板中没有显示头像吧？下面这个错误只是个提示，无需理会"),console.log(e)}if(t.length>0){var o=t[0];null!=o.time&&(kefu.chat.chatMessageStartTime=o.time)}kefu.chat.chatMessageStartTime<1&&(kefu.chat.chatMessageStartTime=(new Date).getTime());var c=setInterval(function(){void 0!==kefu.chat.otherUser.id&&null!=kefu.user&&void 0!==kefu.user.id&&void 0!==kefu.socket.socket&&kefu.socket.socket.readyState==kefu.socket.socket.OPEN&&(kefu.socket.send(JSON.stringify({token:kefu.token.get(),receiveId:kefu.chat.otherUser.id,type:"AUTO_REPLY"})),clearInterval(c),console.log("autoReplyInterval stop"))},200);kefu.chat.init(),document.getElementById("chatcontent").onscroll=function(){document.getElementById("chatcontent").scrollTop<900&&kefu.chat.loadHistoryList()}}),kefu.extend)if(null!=kefu.extend[o].initChat)try{kefu.extend[o].initChat()}catch(e){console.log(e)}},entry:function(e){kefu.currentPage="chat",kefu.ui.chat.render(e);for(var t=kefu.cache.getChatList(),n=null,i=t.length;i>=0;i--)void 0!==t[i]&&e==t[i].id&&(n=t[i]);null!=n&&(n.read||(n.read=!0,kefu.cache.getUser(e,function(e){kefu.cache.pushChatList(e,n),"pc"==kefu.mode&&kefu.ui.list.render()})))},pc:{html:'\n\t\t\t\t\t<div id="pc">    \t\n\t\t\t\t\t\t<header class="chat_header" id="head">\n\t\t\t\t\t\t\t<div class="back" id="back" onclick="kefu.ui.list.entry();">&nbsp;</div>\n\t\t\t\t\t\t\t<div class="title" id="title">\n\t\t\t\t\t\t\t\t<img src="https://res.weiunity.com/kefu/images/head.png" id="otherUserHead" />\n\t\t\t\t\t\t\t\t<div id="headNameState">\n\t\t\t\t\t\t\t\t\t<div id="nickname">在线咨询</div>\n\t\t\t\t\t\t\t\t\t<div id="onlineState">在线</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div id="windowControl">\n\t\t\t\t\t\t\t\t<div id="close" onclick="kefu.ui.chat.pc.close();">&nbsp;</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</header>\n\t\t\t\t\t\t<div id="newMessageRemind">\n\t\t\t\t\t\t\t<div id="newMessageRemindText">\x3c!-- 新消息：消息内容消息内容 --\x3e</div>\n\t\t\t\t\t\t\t<div id="newMessageRemindClose" onclick="document.getElementById(\'newMessageRemind\').style.display=\'none\';">X</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\n\t\t\t\t\t\t<section id="chatcontent" onclick="kefu.ui.chat.pc.switchToJianpanShuruType();">\n\t\t\t\t\t\t</section>\n\t\t\t\t\t\t\n\t\t\t\t\t\t<footer id="chat_footer">\n\t\t\t\t\t\t    <div id="input_area">\n\t\t\t\t\t\t    \t<div id="inputExtend">\n\t\t\t\t\t\t            \x3c!-- 其他，如图片、商品、订单 --\x3e\n\t\t\t\t\t\t\n\t\t\t\t\t\t        </div>\n\t\t\t\t\t\t        <div id="inputExtendShowArea">\n\t\t\t\t\t\t            \x3c!-- inputExtend的显示区域，如表情的显示 --\x3e\n\t\t\t\t\t\t        </div>\n\t\t\t\t\t\t        <div id="textInput">\n\t\t\t\t\t\t        \t<div id="shuruType" onclick="kefu.chat.shuruTypeChange();">\x3c!--输入方式--\x3e</div>\n\t\t\t\t\t\t            \x3c!-- 键盘输入 --\x3e\n\t\t\t\t\t\t            <div id="text" contenteditable="true" onclick="kefu.ui.chat.pc.switchToJianpanShuruType();"></div>\n\t\t\t\t\t\t        </div>\n\t\t\t\t\t\t        <div id="footerButton">\n\t\t\t\t\t\t        \t<div id="copyright" onclick="window.open(\'http://www.kefu.zvo.cn\');">power by 雷鸣云客服</div>\n\t\t\t\t\t\t        \t<button class="send" onclick="kefu.ui.chat.pc.close();">关&nbsp;闭</button>\n\t\t\t\t\t\t        \t<input type="submit" value="发&nbsp;送" class="send" id="sendButton" onclick="kefu.chat.sendButtonClick(); kefu.ui.chat.pc.switchToJianpanShuruType();">\n\t\t\t\t\t\t        </div>\n\t\t\t\t\t\t    </div>\n\t\t\t\t\t\t</footer>\n\t\t\t\t\t</div>\n\t\t\t\t\t',close:function(){document.getElementById("pc").parentNode.removeChild(document.getElementById("pc")),kefu.ui.list.entry()},switchToJianpanShuruType:function(){kefu.chat.shuruType="more",kefu.chat.switchToJianpanShuruType(),kefu.chat.shuruTypeChange(),kefu.chat.switchToJianpanShuruType()},init:function(){kefu.mode="pc",kefu.ui.list.renderAreaId="list",kefu.ui.chat.renderAreaId="chat",kefu.ui.chat.html=kefu.ui.chat.pc.html,kefu.extend.pc={initChat:function(){kefu.chat.shuruType="jianpan",kefu.chat.shuruTypeChange(),kefu.ui.chat.pc.moveInit(),document.getElementById("close").innerHTML=kefu.ui.images.close.replace(/{color}/g,kefu.ui.color.extendIconColor)}},kefu.extend.order.icon=null,kefu.extend.order.sendOrder=function(e,t,n){},kefu.extend.goods.sendGoods=function(e,t){},kefu.extend.image.fullScreen=function(e){window.open(e)},kefu.init()},chatWindowDiv:null,chatHeadWindowDiv:null,x:0,y:0,left:0,top:0,isDown:!1,sizeChange:{currentX:0,currentY:-1,chatWindowHeight:0,height_chat_content_size:0,moveInit:function(){var e=document.getElementById("pc").offsetHeight,t=document.getElementById("chatcontent").offsetHeight;console.log("chatWindowsHeight:"+e+", contentWindowsHeight:"+t),kefu.ui.chat.pc.sizeChange.height_chat_content_size=e-t;var n=document.body;document.getElementById("footerButton").onmousedown=function(e){e.stopPropagation(),e.preventDefault();let t={w:kefu.ui.chat.pc.chatWindowDiv.offsetWidth,h:kefu.ui.chat.pc.chatWindowDiv.offsetHeight,x:e.clientX,y:e.clientY};n.onmousemove=function(e){e.preventDefault();let i=Math.max(300,e.clientX-t.x+t.w),o=Math.max(300,e.clientY-t.y+t.h);o=t.h;if(i=i>=n.offsetWidth-kefu.ui.chat.pc.chatWindowDiv.offsetLeft?n.offsetWidth-kefu.ui.chat.pc.chatWindowDiv.offsetLeft:i,o=n.offsetHeight-kefu.ui.chat.pc.chatWindowDiv.offsetTop,kefu.ui.chat.pc.sizeChange.currentY>0){var c=kefu.ui.chat.pc.sizeChange.chatWindowHeight-(kefu.ui.chat.pc.sizeChange.currentY-e.clientY);console.log(kefu.ui.chat.pc.sizeChange.currentY-e.clientY+", height:"+c),kefu.ui.chat.pc.chatWindowDiv.style.height=c+"px",kefu.ui.chat.pc.sizeChange.chatWindowHeight=c,document.getElementById("chatcontent").style.height=c-kefu.ui.chat.pc.sizeChange.height_chat_content_size+"px"}else kefu.ui.chat.pc.sizeChange.chatWindowHeight=kefu.ui.chat.pc.chatWindowDiv.offsetHeight;kefu.ui.chat.pc.chatWindowDiv.style.width=i+"px",kefu.ui.chat.pc.sizeChange.currentY=e.clientY},n.onmouseleave=function(){n.onmousemove=null,n.onmouseup=null},n.onmouseup=function(){n.onmousemove=null,n.onmouseup=null}}}},moveInit:function(){kefu.ui.chat.pc.chatWindowDiv=document.getElementById("pc"),kefu.ui.chat.pc.chatHeadWindowDiv=document.getElementById("head"),kefu.ui.chat.pc.chatHeadWindowDiv.onmousedown=function(e){kefu.ui.chat.pc.x=e.clientX,kefu.ui.chat.pc.y=e.clientY,kefu.ui.chat.pc.left=kefu.ui.chat.pc.chatHeadWindowDiv.offsetLeft,kefu.ui.chat.pc.top=kefu.ui.chat.pc.chatHeadWindowDiv.offsetTop,kefu.ui.chat.pc.isDown=!0,kefu.ui.chat.pc.chatHeadWindowDiv.style.cursor="move"},window.onmousemove=function(e){if(0!=kefu.ui.chat.pc.isDown){var t=e.clientX,n=e.clientY,i=t-(kefu.ui.chat.pc.x-kefu.ui.chat.pc.left),o=n-(kefu.ui.chat.pc.y-kefu.ui.chat.pc.top);kefu.ui.chat.pc.chatWindowDiv.style.marginLeft=i+"px",kefu.ui.chat.pc.chatWindowDiv.style.marginTop=o+"px"}},kefu.ui.chat.pc.chatHeadWindowDiv.onmouseup=function(){kefu.ui.chat.pc.isDown=!1,kefu.ui.chat.pc.chatHeadWindowDiv.style.cursor="default"}}}}},chat:{otherUser:{},chatMessageStartTime:0,shuruType:"jianpan",getOtherUser:function(e,t){null==kefu.api.getChatOtherUser||kefu.api.getChatOtherUser.length<1?msg.popups("请设置 kefu.api.getChatOtherUser 接口，用于获取跟我沟通的对方的信息"):request.post(kefu.api.getChatOtherUser,{token:kefu.token.get(),id:e},function(e){kefu.chat.otherUser=e.user,void 0!==t&&t(e)})},init:function(){kefu.chat.currentLoadHistoryList=!1,null!=document.getElementById("shuruType")&&(kefu.chat.shuruType="more",kefu.chat.shuruTypeChange())},currentLoadHistoryList:!1,loadHistoryList(){if(!kefu.chat.currentLoadHistoryList){if(kefu.chat.currentLoadHistoryList=!0,kefu.cache.getUserMessageList(kefu.chat.otherUser.id).length<kefu.cache.everyUserNumber)return void console.log("聊天记录不足，没必要再拉更多");var e=document.getElementById("chatcontent"),t=e.getElementsByTagName("section")[0],n=document.createElement("section");n.className="chat bot systemChat",n.id="historyListLoading",n.innerHTML='<div class="text systemText">历史聊天加载中...</div>',e.insertBefore(n,t),request.post(kefu.api.chatLog,{token:kefu.token.get(),otherId:kefu.chat.otherUser.id,time:kefu.chat.chatMessageStartTime,type:"before"},function(e){kefu.chat.currentLoadHistoryList=!1;var t=document.getElementById("chatcontent");t.removeChild(document.getElementById("historyListLoading"));var n=t.getElementsByTagName("section")[0];if("0"==e.result)document.getElementById("chatcontent").onscroll=function(){},msg.failure(e.info);else if("1"==e.result)if(e.number>0){for(var i=e.list.length-1;i>=0;i--){var o=e.list[i],c=kefu.ui.chat.generateMessageSection(o);t.insertBefore(c,n)}kefu.chat.chatMessageStartTime=e.startTime}else kefu.chat.currentLoadHistoryList=!0,t.insertBefore(kefu.ui.chat.generateSystemMessageSection("没有更多了"),n)})}},question:function(e){var t=e.innerHTML;kefu.chat.sendTextMessage(t)},sendTextMessage:function(e){e=e.replace(/\n/g,"[br]");var t={token:kefu.token.get(),type:"MSG",sendId:kefu.user.id,receiveId:kefu.chat.otherUser.id,text:e,time:(new Date).getTime()},n=JSON.stringify(t);return kefu.ui.chat.appendMessage(n),kefu.socket.send(n),kefu.cache.add(n),n},sendPluginMessage:function(e,t){if(null!=t){null!=e?e.extend=t:e={};var n={token:kefu.token.get(),receiveId:kefu.chat.otherUser.id,sendId:kefu.user.id,type:"EXTEND",time:(new Date).getTime(),extend:e};n.text=kefu.extend[t].format(n),kefu.ui.chat.appendMessage(n),n.text="",kefu.socket.send(n),kefu.cache.add(n)}else msg.popups("kefu.chat.sendPluginMessage(data,name) 方法中，请传入name的值。<br/>name是发送这个消息的插件的名字，比如这个插件是 kefu.extend.explain ，那么这里传入的是 'explain'")},sendButtonClick:function(){0!=document.getElementById("text").innerHTML.length?(msg.loading("发送中"),kefu.chat.sendTextMessage(document.getElementById("text").innerHTML),msg.close(),document.getElementById("text").innerHTML="",kefu.ui.chat.textInputClick()):msg.info("尚未输入")},shuruTypeChange:function(){if(null!=document.getElementById("shuruType"))if("jianpan"==kefu.chat.shuruType){kefu.chat.shuruType="more",document.getElementById("shuruType").innerHTML=kefu.ui.images.jianpan.replace(/{color}/g,kefu.ui.color.shuruTypeColor);var e="";for(var t in kefu.extend)null!=kefu.extend[t].icon&&kefu.extend[t].icon.length>0&&(e=e+'<div class="item" onclick="kefu.extend[\''+t+'\'].onclick();"><div class="iconButton">'+kefu.extend[t].icon.replace(/{color}/g,kefu.ui.color.extendIconColor)+'</div><div class="iconName">'+kefu.extend[t].name+"</div></div>");document.getElementById("inputExtend").innerHTML=e,document.getElementById("inputExtend").style.display="",document.getElementById("inputExtendShowArea").style.display=""}else{kefu.chat.shuruType="jianpan",document.getElementById("shuruType").innerHTML=kefu.ui.images.more.replace(/{color}/g,kefu.ui.color.shuruTypeColor),document.getElementById("inputExtendShowArea").innerHTML="";e="";for(var t in kefu.extend)null!=kefu.extend[t].icon&&kefu.extend[t].icon.length>0&&(e=e+'<span class="smallIcon" onclick="kefu.extend[\''+t+"'].onclick();\">"+kefu.extend[t].icon.replace(/{color}/g,kefu.ui.color.extendIconColor)+"</span>");document.getElementById("inputExtend").innerHTML='<div class="extendSmallIcon">'+e+"</div>"}},switchToJianpanShuruType(){null!=document.getElementById("shuruType")&&"jianpan"!=kefu.chat.shuruType&&this.shuruTypeChange()}},cache:{everyUserNumber:20,getUserMessageList:function(e){var t=kefu.storage.get("userid:"+e);return(null==t||t.length<1)&&(t="[]"),JSON.parse(t)},add:function(e){if("string"==typeof e)e=JSON.parse(e);var t=0;if(e.sendId==kefu.user.id?t=e.receiveId:e.receiveId==kefu.user.id&&(t=e.sendId),"SYSTEM"!=e.type&&(console.log(t),"0"!=t&&t.length>0)){var n=kefu.storage.get("userid:"+t);(null==n||n.length<1)&&(n="[]");var i=JSON.parse(n);i.push(e),i.length>this.everyUserNumber&&i.splice(0,1),kefu.storage.set("userid:"+t,JSON.stringify(i)),null!=kefu.chat.otherUser&&null!=kefu.chat.otherUser.id&&kefu.chat.otherUser.id==t?kefu.cache.pushChatList(kefu.chat.otherUser,e):kefu.cache.getUser(t,function(t){kefu.cache.pushChatList(t,e)})}},getChatList:function(){var e=kefu.storage.get("list");return(null==e||e.length<1)&&(e="[]"),JSON.parse(e)},pushChatList:function(e,t){if(null!=e){var n=this.getChatList(),i=t.text;"EXTEND"==t.type&&(i=kefu.extend[t.extend.extend].name);var o={id:e.id,text:i,nickname:e.nickname,head:kefu.getImageUrl(e.head),time:t.time,read:t.read};null==o.time&&(o.time=parseInt((new Date).getTime()/1e3));for(var c=n.length,s=0;s<c;s++)null==n[s]||n[s].id!=e.id||n.splice(s,1);n.push(o),kefu.storage.set("list",JSON.stringify(n))}else msg.popups("出错，kefu.cache.pushChatList 传入的 otherUser 为null")},getUser:function(e,t){var n,i="user_id_"+e,o=kefu.storage.get(i);return null==o||o.length<1?request.send(kefu.api.getChatOtherUser,{token:kefu.token.get(),id:e},function(e){"1"==e.result&&(n=e.user,kefu.storage.set(i,JSON.stringify(e.user)),null!=t&&t(n))},"post",!0,{"content-type":"application/x-www-form-urlencoded"},function(e){console.log("kefu.cache.getUser() 异常："),console.log(e)}):(n=JSON.parse(o),t(n)),n}},extend:{face:{name:"表情",icon:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1603894373099" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2514" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><style type="text/css"></style></defs><path d="M512 979C263.472 979 62 777.528 62 529S263.472 79 512 79s450 201.472 450 450-201.472 450-450 450zM337 479c41.421 0 75-33.579 75-75s-33.579-75-75-75-75 33.579-75 75 33.579 75 75 75z m350 0c41.421 0 75-33.579 75-75s-33.579-75-75-75-75 33.579-75 75 33.579 75 75 75zM312 629c0 110.457 89.543 200 200 200s200-89.543 200-200H312z" fill="{color}" p-id="2515"></path></svg>',format:function(e){return e},faces:{xiaolian:"😀",huaixiao:"😁",se:"😍",feiwen:"😘",waiziuxiao:"😏",yumen:"😒",ai:"😔",tu:"🤮",yun:"😵",nanguo:"🙁",jingkong:"😲",ku:"😭",yangmei:"🤨",miyan:"😆",liuhan:"😅",weixiao:"🙂",xiaoxingxing:"🤩",sikao:"🤔",xu:"🤫",yanmaoqian:"🤑",shenshetou:"😝"},onclick:function(){var e='<div id="inputExtend_Face">';for(var t in kefu.extend.face.faces)e=e+"<span onclick=\"kefu.extend.face.insert('"+t+"');\">"+kefu.extend.face.faces[t]+"</span>";e+="</div>",document.getElementById("inputExtend").style.display="none",document.getElementById("inputExtendShowArea").style.display="",document.getElementById("inputExtendShowArea").innerHTML=e,kefu.chat.shuruType="more"},insert:function(e){document.getElementById("text").innerHTML=document.getElementById("text").innerHTML+kefu.extend.face.faces[e]}},image:{name:"图片",icon:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1603894900121" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><style type="text/css"></style></defs><path d="M955.733333 136.533333H68.266667c-37.546667 0-68.266667 30.72-68.266667 68.266667v614.4c0 37.546667 30.72 68.266667 68.266667 68.266667h887.466666c37.546667 0 68.266667-30.72 68.266667-68.266667V204.8c0-37.546667-30.72-68.266667-68.266667-68.266667z m-154.146133 171.485867a51.2 51.2 0 1 1 0 102.4 51.2 51.2 0 0 1 0-102.4z m48.520533 442.282667H174.1312c-32.392533 0-50.193067-37.6832-29.610667-62.702934l186.504534-226.781866a38.3488 38.3488 0 0 1 59.2384 0L556.373333 662.818133a38.3488 38.3488 0 0 0 59.2384 0l92.2624-112.1792a38.3488 38.3488 0 0 1 59.2384 0l112.64 136.977067c20.548267 25.002667 2.7648 62.685867-29.6448 62.685867z" fill="{color}" p-id="2955"></path></svg>',template:'<img style="max-width: 100%;" onclick="kefu.extend.image.fullScreen(\'{url}\');" src="{url}" />',initChat:function(){var e=document.createElement("input");e.setAttribute("accept","image/gif,image/jpeg,image/jpg,image/png,image/svg,image/bmp"),e.id="imageInput",e.style.display="none",e.type="file",document.body.appendChild(e)},format:function(e){return e.text=kefu.extend.image.template.replace(/{url}/g,kefu.filterXSS(kefu.getImageUrl(e.extend.url))),e},onclick:function(){null==document.getElementById("imageInput").oninput&&(document.getElementById("imageInput").oninput=function(e){if(void 0!==e.srcElement.files[0]){var t=e.srcElement.files[0];msg.loading("上传中"),request.upload(kefu.api.uploadImage,{token:kefu.token.get()},t,function(e){if(msg.close(),"1"==e.result){var t={url:kefu.getImageUrl(e.url)};kefu.chat.sendPluginMessage(t,"image"),kefu.chat.switchToJianpanShuruType()}else msg.failure(e.info)},null,function(){msg.close(),msg.failure("异常")}),document.getElementById("imageInput").value=""}}),document.getElementById("imageInput").click()},fullScreen:function(e){msg.popups({text:'<img src="'+e+'" style="width: 100%; max-width: 100%; " />',width:"95%",opacity:100,padding:"1px"})}},order:{name:"订单",icon:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1603894275814" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1559" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><style type="text/css"></style></defs><path d="M128 891.663059h768a128 128 0 0 0 128-128V260.336941a128 128 0 0 0-128-128H128A128 128 0 0 0 0 260.336941v503.326118a128 128 0 0 0 128 128z m83.425882-475.376941v281.178353c0 31.051294-57.705412 31.171765-57.705411 0V334.697412c0-21.202824 7.589647-31.051294 22.64847-31.834353 12.137412-0.632471 25.057882 5.692235 38.701177 24.244706l202.390588 275.365647v-272.323765c0-37.255529 55.898353-37.225412 55.898353 0v362.767059c0 18.100706-7.559529 26.383059-22.648471 27.196235-13.673412 0.722824-24.786824-6.746353-36.261647-22.64847L211.425882 416.286118z m292.352 149.62447c0-213.232941 272.022588-212.781176 272.022589 0 0 206.667294-272.022588 208.956235-272.022589 0z m52.555294 0c0 128.813176 165.586824 133.782588 165.586824 0 0-73.667765-40.749176-103.695059-83.245176-102.912-42.496 0.783059-82.341647 32.406588-82.341648 102.912z m285.093648 97.249883c15.872 0 28.822588 12.950588 28.822588 28.822588s-12.950588 28.822588-28.822588 28.822588-28.822588-12.950588-28.822589-28.822588 12.950588-28.822588 28.822589-28.822588z" fill="{color}" p-id="1560"></path></svg>',css:"./extend/order/style.css",requestApi:goodsUrl+"orderList.json",format:function(e){return e.text=kefu.extend.order.getOrderByTemplate(e.extend),e},listTemplate:'\n\t\t\t\t<div class="extend_order_item" onclick="kefu.extend.order.sendOrder(\'{order.no}\', this, \'{id}\');">  \n\t\t\t\t    <div class="orderInfo">\n\t\t\t\t        <div class="order_no">订单号：{order.no}</div>\n\t\t\t\t        <div class="order_time">{order.time}</div>\n\t\t\t\t    </div>\n\t\t\t\t    <div class="goodsInfo">\n\t\t\t\t    \t<img class="image" src="{goods.image}" />\n\t\t\t\t\t    <div class="goodsAttr">\n\t\t\t\t\t        <div class="name">{goods.name}</div>\n\t\t\t\t\t        <div class="priceState">\n\t\t\t\t\t            <div class="price">{goods.price}</div>\n\t\t\t\t\t            <div class="state">{order.state}</div>\n\t\t\t\t\t        </div>\n\t\t\t\t\t    </div>\n\t\t\t\t    </div>\n\t\t\t\t</div>\n\t\t\t\t<hr class="extend_order_hr" />\n\t\t\t',orderMap:{},getOrderByTemplate:function(e){return kefu.extend.order.listTemplate.replace(/{order.no}/g,kefu.filterXSS(e.no+"")).replace(/{order.time}/g,kefu.filterXSS(e.time+"")).replace(/{goods.image}/g,kefu.filterXSS(e.image)).replace(/{id}/g,kefu.filterXSS(e.id+"")).replace(/{goods.name}/g,kefu.filterXSS(e.name)).replace(/{goods.price}/g,kefu.filterXSS(e.price+"")).replace(/{order.state}/g,kefu.filterXSS(e.state+""))},onclick:function(){msg.loading("获取中"),request.post(kefu.extend.order.requestApi,{token:kefu.token.get(),zuoxiid:kefu.chat.otherUser.id,myid:kefu.user.id},function(e){msg.close();for(var t="",n=0;n<e.length;n++)kefu.extend.order.orderMap[e[n].id]=e[n],t+=kefu.extend.order.getOrderByTemplate(e[n]);msg.popups({text:t,top:"10%",height:"20rem"})})},sendOrder:function(e,t,n){if("text"!=t.parentElement.className){var i=kefu.extend.order.orderMap[n];msg.close(),kefu.chat.sendPluginMessage(i,"order")}else kefu.extend.order.otherShow(e)},otherShow:function(e){void 0!==window.webkit&&void 0!==window.webkit.messageHandlers?"function"==typeof window.webkit.messageHandlers.appShowOrder.postMessage&&window.webkit.messageHandlers.appShowOrder.postMessage(e):alert("待编写。这里应该是跳转到原生app的订单详情中进行查看")}},goods:{name:"商品",css:"./extend/goods/style.css",init:function(){},format:function(e){return e.text=kefu.extend.goods.getGoodsByTemplate(e.extend),e},template:'\n\t\t\t\t\x3c!-- 弹出的商品发送 --\x3e\n\t\t\t    <div class="extend_goods_item" onclick="kefu.extend.goods.sendGoods(\'{id}\', this);">  \n\t\t\t        <img class="image" src="{image}" />\n\t\t\t        <div class="goodsInfo">\n\t\t\t            <div class="name">{name}</div>\n\t\t\t            <div class="priceDiv">\n\t\t\t            \t<div class="price">{price}</div>\n\t\t\t            \t<div class="sendButtonDiv"><button>发送商品</button></div></div>\n\t\t\t        </div>\n\t\t\t    </div>\n\t\t\t',goods:{},getGoodsByTemplate:function(e){return kefu.extend.goods.template.replace(/{id}/g,kefu.filterXSS(e.id)).replace(/{name}/g,kefu.filterXSS(e.name)).replace(/{price}/g,kefu.filterXSS(e.price)).replace(/{image}/g,kefu.filterXSS(e.image))},sendGoods:function(e,t){"text"!=t.parentElement.className?(e!=kefu.extend.goods.goods.id&&msg.failure("商品id异常！"),msg.close(),kefu.chat.sendPluginMessage(kefu.extend.goods.goods,"goods")):kefu.extend.goods.otherShow(e)},otherShow:function(e){void 0!==window.webkit&&void 0!==window.webkit.messageHandlers?"function"==typeof window.webkit.messageHandlers.appShowGoods.postMessage&&window.webkit.messageHandlers.appShowGoods.postMessage(e):alert("待编写。这里应该是跳转到原生app的商品详情中进行查看")}}},socket:{url:"ws://xxxxxx",socket:null,heartBeat:{time:50,text:'{"type":"HEARTBEAT","text":"AreYouThere"}',isStart:!1,startHeartBeat:function(){if(0==kefu.socket.heartBeat.isStart){setInterval(function(){kefu.socket.send(kefu.socket.heartBeat.text)},1e3*kefu.socket.heartBeat.time);kefu.socket.heartBeat.isStart=!0,console.log("kefu.socket headrtBeat thread start")}}},onopen:function(){kefu.socket.send(JSON.stringify({type:"CONNECT",token:kefu.token.get()})),kefu.socket.heartBeat.startHeartBeat()},onmessage:function(e){var t=JSON.parse(e.data);null!=t.type&&"HEARTBEAT"==t.type||(t.text=kefu.getReceiveMessageText(t),t.read=!1,"pc"==kefu.mode?"chat"==kefu.currentPage&&(t.sendId==kefu.chat.otherUser.id?(t.read=!0,kefu.ui.chat.appendMessage(t)):console.log("不是这个人的，不再这个chat中显示消息")):"list"==kefu.currentPage||(t.sendId==kefu.chat.otherUser.id||"SYSTEM"==t.type?(t.read=!0,kefu.ui.chat.appendMessage(t)):kefu.ui.chat.newMessageRemind(t)),kefu.cache.add(t),"pc"!=kefu.mode&&"list"!=kefu.currentPage||kefu.cache.getUser(t.sendId,function(e){kefu.ui.list.render()}),kefu.notification.execute("您有新消息",t.text))},connect:function(e){this.url=e,this.reconnect.connect();setInterval(function(){kefu.socket.socket.readyState==kefu.socket.socket.CLOSED&&(console.log("socketCloseAgainConnectInterval : socket closed , again connect ..."),kefu.socket.reconnect.connect())},3e3)},reconnect:{connecting:!1,connect:function(){this.connecting||(console.log("socket connect ... "+(new Date).toLocaleString()),kefu.socket.reconnect.connecting=!0,kefu.socket.socket=new WebSocket(kefu.socket.url),kefu.socket.socket.onopen=function(){kefu.socket.onopen()},kefu.socket.socket.onmessage=function(e){kefu.socket.onmessage(e)},this.connecting=!1)}},send:function(e){kefu.socket.socket.readyState==kefu.socket.socket.OPEN?("object"==typeof e&&(e=JSON.stringify(e)),kefu.socket.socket.send(e)):kefu.socket.socket.readyState!=kefu.socket.socket.CLOSED&&kefu.socket.socket.readyState!=kefu.socket.socket.CLOSING||(console.log("socket 已关闭，正在开启重连"),kefu.socket.reconnect.connect(),kefu.socket.send(e))}}};