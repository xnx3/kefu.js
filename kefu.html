<!DOCTYPE html>
<html lang="zh-cn"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta http-equiv="Content-Language" content="zh-CN">
<meta name="author" content="管雷鸣">
<title>聊天列表</title>
<script src="http://res.weiunity.com/msg/msg.js--"></script>
<script src="./msg.js"></script>
<script src="kefu.js"></script>
<link rel="stylesheet" type="text/css" href="./css/style.css" media="screen">
</head>
<body>
<script type="text/javascript">
var host = 'kefu.wfyuntu.com';
var socketUrl = 'ws://kefu.wfyuntu.com:8081/';
//var host = 'localhost:8080';
//var socketUrl = 'ws://localhost:8081/';

//kefu.js 接口设置
//kefu.api.getMyUser = 'http://'+host+'/user/init.json';
kefu.api.getMyUser = 'http://'+host+'/inset/chat/login.json';
kefu.api.getChatOtherUser = 'http://'+host+'/user/getUserById.json';
kefu.api.chatLog = 'http://'+host+'/chatLog.json';
kefu.api.uploadImage = 'http://'+host+'/uploadImage.json';
kefu.extend.order.requestApi = 'http://test.wfyuntu.com/plugin/kefu/getOrderList.json';


//在APP中初始化，传入如 window.webkit.messageHandlers
function appInit(obj){
	if(typeof(obj.appStorageSet) == 'function'){
		console.log('重写 appStorageGet(orderid)');
		kefu.storage.get = function(key){
			return obj.appStorageGet(key);
		};
	}
	if(typeof(obj.appStorageSet) == 'function'){
		console.log('重写 appStorageSet(orderid)');
		kefu.storage.set = function(key, value){
			obj.appStorageSet(key,value);
		}
	}
	if(typeof(obj.appShowGoods) == 'function'){
		console.log('重写 appShowGoods(goodsid)');
		kefu.extend.goods.otherShow=function(goodsid){
			obj.appShowGoods(goodsid);
		}
	}
	if(typeof(obj.appShowOrder) == 'function'){
		console.log('重写 appShowOrder(orderid)');
		kefu.extend.order.otherShow=function(orderid){
			alert('appShowOrder');
			obj.appShowOrder(orderid);
		}
	}
	
}
//在原生APP中使用，重写android、ios的某些方法
if(typeof(messageHandlers) != 'undefined' && typeof(messageHandlers.appStorageGet) == 'function'){
	//如果是安卓手机
	appInit(messageHandlers);
}else if(typeof(window.webkit) != 'undefined' && typeof(window.webkit.messageHandlers) != 'undefined'){
	//ios中使用
	appInit(window.webkit.messageHandlers);
}


/****** chatQuickButton插件 ******/
kefu.extend.chatQuickButton = {
	css:'./extend/chatQuickButton/style.css',
	//进入chat一对一聊天窗口时，自动执行这个方法初始化
	initChat:function(){
		var chatQuickButtonHtml = `
				<section id="quickButton">
					<button onclick="kefu.chat.sendTextMessage('otherToken:'+getUrlParams('otherToken'));">发token</button>
				    <button>售后</button>
				    <button>评价</button>
				    <button>物流查询</button>
				    <button>按钮1</button>
				    <button>按钮2</button>
				    <button>按钮3</button>
				    <button>按钮4</button>
				    <button>按钮5</button>
				</section>
			`;
		document.getElementById('chat_footer').innerHTML = chatQuickButtonHtml+document.getElementById('chat_footer').innerHTML;
	}
}
/****** chatQuickButton插件结束 ******/


/****** goods插件 *******/
kefu.extend.goods.goodsid = getUrlParams('goodsid');	//根据url传入的goodsid，来弹出是否发送商品的提示
kefu.extend.goods.goods_show = false; //是否已经显示过了，只显示一次商品发送提示就可以。false是未显示过，可以显示商品发送提示
//初始化，当打开chat窗口时，所有初始化的东西完事后，会自动执行此处
kefu.extend.goods.initChat = function(){
	if(kefu.extend.goods.goodsid != null && kefu.extend.goods.goodsid.length > 0){
		if(!kefu.extend.goods.goods_show){
			//通过接口获取这个指定的商品信息，弹出显示，提醒用户是否发送这个商品
		    msg.loading('获取中');
		    request.post('http://test.wfyuntu.com/plugin/kefu/getGoods.json',{token:kefu.getToken(), goodsid:kefu.extend.goods.goodsid}, function(data){
		        msg.close();
		        kefu.extend.goods.goods = data.data;
		        msg.popups(kefu.extend.goods.getGoodsByTemplate(kefu.extend.goods.goods));
		    });
		    kefu.extend.goods.goods_show = true;
		    console.log('显示了goods');
    	}
	}
};
/****** goods插件结束 *******/

/****** order插件开始 *******/
kefu.extend.order.showOrder=function (){
	msg.loading('获取中');
	request.post(kefu.extend.order.requestApi,{token:kefu.getToken(), zuoxiid:kefu.chat.otherUser.id, myid:kefu.user.otherUserId}, function(data){
		msg.close();
		if(data.result != '1'){
			msg.failure(data.info);
			return;
		}
		if(data.data.length == 0){
			msg.info('您在当前店铺没有订单');
			return;
		}
		
		var html = '';
		for (var i = 0; i < data.data.length; i++) {
			kefu.extend.order.orderMap[data.data[i]['no']] = data.data[i];
			html = html + kefu.extend.order.getOrderByTemplate(data.data[i]);
		};
		msg.popups({
			text:html,
			top:'2rem',
			height:'30rem'
		});
		
	});
};
/****** order插件结束 *******/

/******* 爱送达定制 ********/

kefu.extend.aisongda = {
	//进入chat一对一聊天窗口时，自动执行这个方法初始化
	initChat:function(){
		//隐藏chat页面的头部
		document.getElementById('head').style.display = 'none';
		document.getElementById('chatcontent').style.paddingTop='0rem';
	}
}
/******* 爱送达定制结束 ********/



//kefu.js 初始化
kefu.init();

/***** 爱送达专用 *****/
//kefu.getMyUser();	//获取我的信息
var urlOtherToken = getUrlParams('otherToken');
if(urlOtherToken == null || urlOtherToken.length < 1){
	console.log('未传入otherToken');
	//alert('未传入otherToken');
}
kefu.getMyUser = function(){
	if(kefu.api.getMyUser == null || kefu.api.getMyUser.length < 1){
		msg.popups('请设置 kefu.api.getMyUser 接口，用于获取当前用户(我)的信息');
		return;
	}
	request.post(kefu.api.getMyUser,{token:kefu.getToken(), otherToken:urlOtherToken, }, function(data){
		if(data.result == '0'){
			msg.failure(data.info);
		}else{
			kefu.user = data.user;
			kefu.user.otherUserId = data.otherUserId;
			socket.connect(socketUrl);	//建立 socket 通讯
		}
	});
}
kefu.getMyUser();
/***** 爱送达专用结束 *****/

</script>

</body>


<script>
var page = getUrlParams('page');
if(typeof(page) == 'string' && page == 'chat'){
    //出现聊天页
    var userid = getUrlParams('userid');
    kefu.ui.chat.render(userid);
}else{
    //出现列表页
    kefu.ui.list.render();
}

</script>
</html>